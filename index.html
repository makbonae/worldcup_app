/ver2015-03
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì „ê³µí•™ê³¼ ì›”ë“œì»µ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-size: 24px;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      background: #f9f9f9;
    }
    .input-container, .instruction, .category-select, .tournament, .result-area, .round-loading {
      display: none;
      margin-top: 50px;
    }
    .input-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      height: 100vh;
    }
    .input-container input,
    .input-container button {
      width: 300px;
      height: 48px;
      font-size: 18px;
      padding: 10px 16px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .category-select {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    .bold-major {
      font-weight: bold;
      font-size: 48px;
      color: black;
    }
    .friend-text {
      font-size: 24px;
      color: #007ACC;
      margin-top: 30px;
      word-break: keep-all;
      overflow-wrap: break-word;
      white-space: normal;
      line-height: 1.5em;
    }
    .card {
      display: inline-block;
      width: 40%;
      margin: 20px;
      padding: 30px;
      border: 2px solid #aaa;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      vertical-align: top;
    }
    .card-pair {
      display: flex;
      justify-content: center;
      align-items: stretch;
      gap: 40px;
      margin-bottom: 0px;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #555;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    table {
      margin: auto;
      border-collapse: collapse;
      margin-top: 20px;
    }
    td, th {
      border: 1px solid #ccc;
      padding: 10px 10px;
    }
    button {
      font-size: 24px;
      margin: 10px;
      padding: 10px 20px;
    }
    .circle-list {
      list-style: none;
      counter-reset: section;
      padding-left: 0;
    }
    .circle-list li {
      counter-increment: section;
      position: relative;
      padding-left: 1.5em; /* ë¦¬ìŠ¤íŠ¸ ë²ˆí˜¸ ê³µê°„ í™•ë³´ (ì—¬ë°± ì¡°ì • ê°€ëŠ¥) */
      text-indent: 0;
    }
    .circle-list li::before {
      content: counter(section, upper-roman) ".";
      position: absolute;
      left: 0;
      width: 1.5em;        /* ë²ˆí˜¸ ê³µê°„ í™•ë³´ */
      display: inline-block;
    }
    .highlight-doc {
      color: #007ACC;
    }
  </style>
</head>
<body>
  <div class="input-container" id="inputForm">
    <input id="school" placeholder="í•™êµëª…">
    <div style="height:10px"></div>
    <input id="student_id" placeholder="í•™ë²ˆ">
    <div style="height:10px"></div>
    <input id="student_name" placeholder="ì´ë¦„">
    <div style="height:10px"></div>
    <button onclick="showInstruction()">ë‹¤ìŒ</button>
  </div>
  <div class="instruction" id="instruction" style="max-width: 900px; margin: auto; text-align: left; line-height: 1.5em;">
    <ul class="circle-list">
      <li>ë³¸ í”„ë¡œê·¸ë¨ì€ ëŒ€í•™ ì „ê³µí•™ê³¼ì— ëŒ€í•œ ê´€ì‹¬ ìˆ˜ì¤€ê³¼ ê³ ë“±í•™êµ ê³¼ëª© ì„ íƒì— ëŒ€í•œ ì´í•´ë¥¼ ë•ê¸° ìœ„í•´ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
      <li>ì„œìš¸ì‹œêµìœ¡ì²­êµìœ¡ì •ë³´ì›ì—ì„œ ë°œê°„í•œ <span class="highlight-doc">ã€Œ2015 ê°œì • êµìœ¡ê³¼ì • ì„ íƒê³¼ëª© ì•ˆë‚´ì„œã€</span>ë¥¼ ì°¸ê³ í•˜ì˜€ìœ¼ë©°, ìì„¸í•œ ì‚¬í•­ì€ í•´ë‹¹ ìë£Œë¥¼ ì°¸ê³ í•˜ê¸° ë°”ëë‹ˆë‹¤.</li>
      <li><span class="highlight-doc">[ì¸ë¬¸+ê³µí†µ], [ìì—°+ê³µí†µ] 2ê°œ ì¹´í…Œê³ ë¦¬ ì¤‘ì— í•˜ë‚˜ë¥¼ ì„ íƒ</span>í•˜ì—¬ ì „ê³µí•™ê³¼ ì›”ë“œì»µì„ ì§„í–‰í•©ë‹ˆë‹¤.</li>
      <li><span class="highlight-doc">ê³µí†µ 3ê°œ, ì¸ë¬¸ 36ê°œ, ìì—° 57ê°œ í•™ê³¼ë¡œ êµ¬ì„±</span>í•˜ì˜€ìœ¼ë©°, [ì¸ë¬¸+ê³µí†µ]ì€ ë¬´ì‘ìœ„ë¡œ ì„ íƒëœ 32ê°œ í•™ê³¼ë¡œ 32ê°•ë¶€í„°, [ìì—°+ê³µí†µ]ì€ 64ê°•ë¶€í„° ì‹œì‘í•˜ë©° 4ê°œì˜ í•™ê³¼ê°€ ë¶€ì „ìŠ¹ìœ¼ë¡œ 32ê°•ì— ì§„ì¶œí•©ë‹ˆë‹¤.</li>
      <li>ë‘ ê°œì˜ ì „ê³µí•™ê³¼ê°€ ì§(pair)ì„ ì´ë£¨ì–´ ë³´ì—¬ì§€ë©´, <span class="highlight-doc">ë³´ë‹¤ ê´€ì‹¬ì´ ìˆëŠ” í•™ê³¼ë¥¼ ì„ íƒ</span>í•˜ê¸° ë°”ëë‹ˆë‹¤.</li>
      <li>2íšŒê¹Œì§€ ê²°ê³¼ë¥¼ ëˆ„ì í•  ìˆ˜ ìˆê³ , <span class="highlight-doc">2ë²ˆì˜ ë¼ìš´ë“œë¥¼ ë§ˆì¹˜ë©´ ì„ íƒí•œ ì „ê³µ í•™ê³¼ë³„ë¡œ ê³ ë“±í•™êµ ì„ íƒê³¼ëª©ì— ëŒ€í•œ ì•ˆë‚´</span>ë¥¼ ë°›ì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤ë©´ ì•„ë˜ ê³„ì—´ì„ ì„ íƒí•˜ê³  ì „ê³µí•™ê³¼ ì´ìƒí˜• ì›”ë“œì»µì„ ì‹œì‘í•˜ê¸° ë°”ëë‹ˆë‹¤.</li>
    </ul>
    <div class="category-select" style="justify-content: flex-start; margin-top: 20px;">
      <button onclick="startCategory('inmun2024')">ì¸ë¬¸+ê³µí†µ</button>
      <button onclick="startCategory('jayeon2024')">ìì—°+ê³µí†µ</button>
    </div>
  </div>

  
  <div class="round-loading" id="roundLoading">
    <div class="spinner"></div>
    <p id="roundText"></p>
  </div>
  
  <div class="tournament" id="tournament"></div>
  <div class="result-area" id="resultArea"></div>
  <div id="repeatButton"></div>
  <div id="pdfButton"></div>

  <script>
    const SUPABASE_URL = 'https://vgnnzehkzbrsatdyoqzf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnbm56ZWhremJyc2F0ZHlvcXpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzUyNTksImV4cCI6MjA2Njk1MTI1OX0.ANWPKzugvztZLkYm5P9og9ENF-SG4QcTi9s1RBOO1DA';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    let roundData = [];
    let roundResults = [];
    let roundHistory = [];
    let currentRound = 1;
    let maxRounds = 2;
    let userInfo = {};
    let selectedCategory = '';

    document.getElementById('inputForm').style.display = 'block';

    function showInstruction() {
      userInfo.school = document.getElementById('school').value;
      userInfo.id = document.getElementById('student_id').value;
      userInfo.name = document.getElementById('student_name').value;
      document.getElementById('inputForm').style.display = 'none';
      document.getElementById('instruction').style.display = 'block';
    }

    async function startCategory(table) {
      selectedCategory = table;
      document.getElementById('instruction').style.display = 'none';
      document.getElementById('resultArea').style.display = 'none';
      document.getElementById('repeatButton').style.display = 'none';
      document.getElementById('pdfButton').style.display = 'none';
      
      // âœ… ì‹œì‘ ë¼ìš´ë“œ ì´ë¦„ ì§€ì •
      let startRoundName = '64ê°•';
      if (table === 'inmun2024') startRoundName = '32ê°•';
      showLoading(startRoundName);

      let { data, error } = await supabaseClient.from(table).select('*');
      if (error) return alert('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');

      data = shuffleArray(data);
        
      if (table === 'inmun2024') {
        const selected = data.slice(0, 32);           // ì „ì²´ 56ê°œ ì‚¬ìš©
        roundData = buildTournament(selected);
        delete roundData.autoPass;
      } else {
        const selected = data.slice(0, 60);           // ì „ì²´ 60ê°œ ì‚¬ìš©
        const autoPass = selected.slice(0, 4);        // ë¶€ì „ìŠ¹ 4ê°œ
        const others = selected.slice(4);             // ë‚˜ë¨¸ì§€ 56ê°œë¡œ 64ê°• ì§„í–‰
        roundData = buildTournament(others);          // 64ê°•: 28ìŒ
        roundData.autoPass = autoPass;                // ì´í›„ 32ê°•ì—ì„œ ì‚¬ìš©
      }

      setTimeout(() => {
        hideLoading();
        document.getElementById('tournament').style.display = 'block';
        playRound(roundData);
      }, 2000);
    }

    function shuffleArray(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    function buildTournament(items) {
      return shuffleArray(items);
    }


    function playRound(pairs) {
      const container = document.getElementById('tournament');
      container.innerHTML = '';

      if (pairs.length === 28 && roundData.autoPass) {
        pairs = [...pairs, ...roundData.autoPass];
        delete roundData.autoPass;
      }

      if (pairs.length === 1) {
        saveRoundResult(pairs[0]);
        showSummary();
        return;
      }

      roundData = pairs;
      roundHistory.push([...pairs]);
      const nextRound = [];
      let index = 0;

      function nextPair() {
        container.innerHTML = '';
        
        if (index >= pairs.length) {
          let nextRoundName;
          if (index >= pairs.length) {
            let nextRoundName;

            if (nextRound.length === 1) {
              nextRoundName = 'ìµœì¢… ì„ íƒ ê²°ê³¼ ';  // âœ… ë¨¼ì € ê²€ì‚¬
            } else if (nextRound.length === 2) {
              nextRoundName = 'ê²°ìŠ¹'; // âœ… 2ê°•ì´ ì•„ë‹ˆë¼ ê²°ìŠ¹ìœ¼ë¡œ í‘œê¸°
            } else if (nextRound.length === 28 && roundData.autoPass) {
              nextRoundName = '32ê°•';
            } else {
              nextRoundName = `${nextRound.length}ê°•`;
            }

          showLoading(nextRoundName);
          setTimeout(() => {
            hideLoading();
            playRound(nextRound);
          }, 2000);
          return;
        }
        
        const card1 = pairs[index];
        const card2 = pairs[index + 1];
        const cardA = createCard(card1);
        const cardB = createCard(card2);

        const wrapper = document.createElement('div');
        wrapper.className = 'card-pair';
        wrapper.appendChild(cardA);
        wrapper.appendChild(cardB);
        container.appendChild(wrapper);

        // âœ… ì„¸ë¡œ ê¸¸ì´ë§Œ ë™ê¸°í™” (ê°€ë¡œëŠ” 40% ê³ ì •)
        setTimeout(() => {
          const heightA = cardA.offsetHeight;
          const heightB = cardB.offsetHeight;
          const maxHeight = Math.max(heightA, heightB);
          cardA.style.height = `${maxHeight}px`;
          cardB.style.height = `${maxHeight}px`;
        }, 0);

        cardA.onclick = () => { nextRound.push(card1); index += 2; nextPair(); };
        cardB.onclick = () => { nextRound.push(card2); index += 2; nextPair(); };
      }
      nextPair();
    }

    function createCard(item) {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `<div class='bold-major'>${item.major}</div><div class='friend-text'>${item.friends}</div>`;
      return div;
    }

    function saveRoundResult(winner) {
      const finals = roundHistory.at(-1)?.slice(0, 2) || [];
      const semis = roundHistory.at(-2)?.slice(0, 4) || [];
      const quarters = roundHistory.at(-3)?.slice(0, 8) || [];
      roundResults.push({ final: winner, finals, semis, quarters });
    }

    function showSummary() {
      document.getElementById('tournament').style.display = 'none';
      const result = document.getElementById('resultArea');
      result.style.display = 'block';
      let html = `<p>${userInfo.school} ${userInfo.id} ${userInfo.name} ë‹˜ì˜ ì„ íƒ ê²°ê³¼</p>`;
      roundResults.forEach((round, idx) => {
        const finals = round.finals.filter(x => x.major !== round.final.major);
        const semis = round.semis.filter(x => !round.finals.includes(x));
        const quarters = round.quarters.filter(x => !round.semis.includes(x));

        html += `<h3>Round ${idx + 1}</h3><table><tr><th>êµ¬ë¶„</th><th>ì„ íƒ</th><th>ì „ê³µ</th>`;
        html += `<tr><td>ìµœì¢…ì„ íƒ</td><td><input type='checkbox' class='desc-check' data-major='${round.final.major}'></td><td>${round.final.major}</td></tr>`;
        finals.forEach(item => html += `<tr><td>ê²°ìŠ¹ì§„ì¶œ</td><td><input type='checkbox' class='desc-check' data-major='${item.major}'></td><td>${item.major}</td></tr>`);
        if (semis.length > 0) {
          html += `<tr><td rowspan="1">4ê°•ì§„ì¶œ</td>`;
          semis.forEach(item => html += `<td><input type='checkbox' class='desc-check' data-major='${item.major}'></td><td>${item.major}</td>`);
          html += `</tr>`;
        }
        if (quarters.length > 0) {
          html += `<tr><td rowspan="1">8ê°•ì§„ì¶œ</td>`;
          quarters.forEach(item => html += `<td><input type='checkbox' class='desc-check' data-major='${item.major}'></td><td>${item.major}</td>`);
          html += `</tr>`;
        }
        html += `</table>`;
      });
      result.innerHTML = html;

      if (currentRound < maxRounds) {
        document.getElementById('repeatButton').innerHTML = '<button onclick="repeatRound()">ê²°ê³¼ ì €ì¥í•˜ê³  í•œ ë²ˆ ë”!</button>';
        document.getElementById('repeatButton').style.display = 'block';
      } else {
        document.getElementById('pdfButton').innerHTML = `
          <p style="font-size: 20px; margin-bottom: 10px;">
          â€» ê´€ì‹¬ ìˆëŠ” ì „ê³µ í•™ê³¼ì— ì²´í¬í•œ í›„ <strong>ì„¤ëª…ë³´ê¸°</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.<br>
             (ì„¤ëª…ë³´ê¸°ëŠ” ìƒˆ ì°½ì—ì„œ ì—´ë¦¬ë©°, <strong>íŒì—… ì°¨ë‹¨</strong>ì´ ì„¤ì •ëœ ê²½ìš° ë³´ì´ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
          ğŸ‘‰ iPad ì‚¬ìš©ì: [ì„¤ì •] > [Safari] > [íŒì—… ì°¨ë‹¨] í•´ì œ<br>
          ğŸ‘‰ Android ì‚¬ìš©ì: [Chrome ì„¤ì •] > [ì‚¬ì´íŠ¸ ì„¤ì •] > [íŒì—… ë° ë¦¬ë””ë ‰ì…˜] â†’ í—ˆìš©)
          </p>
          
          <div>
            <button onclick="downloadPDF()">PDF ì €ì¥</button>
            <button onclick="openDescriptions()">ì„¤ëª…ë³´ê¸°</button>
          </div>
        `;
        document.getElementById('pdfButton').style.display = 'block';
      }
    }

    async function openDescriptions() {
      const checked = document.querySelectorAll('.desc-check:checked');
      const majors = Array.from(checked).map(cb => cb.dataset.major);
      if (majors.length === 0) return alert('ì„ íƒëœ ì „ê³µì´ ì—†ìŠµë‹ˆë‹¤');

      const { data, error } = await supabaseClient
        .from(selectedCategory)
        .select('*')
        .in('major', majors);
      if (error) return alert('ì„¤ëª… ë¡œë”© ì‹¤íŒ¨');

      let htmlContent = `
        <!DOCTYPE html>
        <html lang="ko">
        <head>
          <meta charset="UTF-8">
          <title>ì„ íƒ í•™ê³¼ ìƒì„¸ ì„¤ëª…</title>
          <style>
            body { font-family: sans-serif; font-size: 18px; padding: 20px; line-height: 2.0; }
            .major-block { margin-bottom: 40px; }
            .major-title { color: black; font-weight: bold; font-size: 24px; }
            .section-label { color: black; font-weight: bold; }
            .subject-label { color: black; font-weight: bold; }
            .section-divider { color: dodgerblue; font-weight: bold; margin: 20px 0 10px; }
            .print-button { margin-top: 40px; }
          </style>
        </head>
        <body>
          <p style="font-size: 24px; margin-bottom: 40px;">
            <strong>${userInfo.school} ${userInfo.id} ${userInfo.name}</strong> ë‹˜ì˜ ì„ íƒí•œ ì „ê³µ í•™ê³¼ì— ëŒ€í•œ ì•ˆë‚´ì…ë‹ˆë‹¤.
          </p>
      `;

      data.forEach((d, i) => {
        htmlContent += `
          <div class="major-block">
            <div class="major-title">ğŸ”– ì„ íƒ ì „ê³µ: ${d.major}</div>
            <div><span class="section-label">1. ì „ê³µ í•™ê³¼: </span>${d.major_ref}</div>
            <div><span class="section-label">2. í•™ê³¼ ê°œìš”: </span>${d.desc}</div>
            <div><span class="section-label">3. ìœ ì‚¬ í•™ê³¼: </span>${d.friends}</div>
            <div class="section-divider">ğŸ“– ê´€ë ¨ ê³ ë“±í•™êµ ì„ íƒ ê³¼ëª© ì˜ˆì‹œ</div>
            <div><span class="section-label">4. ì¼ë°˜ ì„ íƒ ê³¼ëª©: </span>${d.sub1 || 'ì •ë³´ ì—†ìŒ'}</div>
            <div><span class="section-label">5. ì§„ë¡œ ì„ íƒ ê³¼ëª©: </span>${d.sub2 || 'ì •ë³´ ì—†ìŒ'}</div>
            <div><span class="section-label">6. ìœµí•© ì„ íƒ ê³¼ëª©: </span>${d.sub3 || 'ì •ë³´ ì—†ìŒ'}</div>
          </div>
        `;
      });

      htmlContent += `
          <div class="print-button">
            <button onclick="window.print()" style="font-size:18px; padding: 10px 20px;">ğŸ“„ ì¸ì‡„í•˜ê¸°</button>
          </div>
        </body>
        </html>
      `;

      const win = window.open('', '_blank');
      win.document.write(htmlContent);
      win.document.close();
    }


    function downloadPDF() {
      const element = document.getElementById('resultArea');
      html2canvas(element).then(canvas => {
        const img = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF();
        pdf.addImage(img, 'PNG', 10, 10, 190, 0);
        pdf.save(`${userInfo.id}_${userInfo.name}_ë‹˜ì˜ ì „ê³µí•™ê³¼ ì›”ë“œì»µ ê²°ê³¼.pdf`);
      });
    }

    function repeatRound() {
      currentRound++;
      startCategory(selectedCategory);
    }

    function showLoading(name) {
      document.getElementById('roundLoading').style.display = 'block';
      document.getElementById('roundText').innerText = `${name} ë¡œë”©ì¤‘...`;
    }

    function hideLoading() {
      document.getElementById('roundLoading').style.display = 'none';
    }

    // âœ… ì˜¤ë¥¸ìª½ í´ë¦­ ë°©ì§€
    document.addEventListener('contextmenu', function (e) {
      e.preventDefault();
    });
    
  </script>
</body>
</html>
